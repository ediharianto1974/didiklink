<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Import Murid | ClassTrack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="glass w-full max-w-md shadow-2xl">
    <h1 class="text-2xl font-bold mb-4 text-center">üì¶ Import Data Murid</h1>
    <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-3 mb-4">
        <p class="text-[11px] text-blue-200 text-center">
          Format CSV: <code class="bg-black/40 px-1 rounded">nama, kelas</code><br>
          Contoh: <code class="bg-black/40 px-1 rounded">NUR QAIRA ZULAIKHA, 5 JUJUR</code>
        </p>
    </div>

    <div class="space-y-4">
        <input type="file" id="csvFile" accept=".csv" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700 cursor-pointer">
        
        <button onclick="importCSV()" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold transition transform active:scale-95">
          Mula Import ke Firestore
        </button>
    </div>

    <p id="status" class="mt-4 text-sm text-center text-gray-300 font-medium"></p>

    <div class="mt-6 text-center border-t border-white/10 pt-4">
      <button onclick="window.location.href='teacher-dashboard.html'" class="text-sm text-cyan-400 hover:text-cyan-300 transition flex items-center justify-center gap-2 mx-auto">
        <span>‚Üê</span> Kembali ke Dashboard Guru
      </button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Inisialisasi Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyDozc46BtKOvWfBMcujmAYO89xA1q36a2E",
        authDomain: "classmanagement-d0085.firebaseapp.com",
        projectId: "classmanagement-d0085",
        storageBucket: "classmanagement-d0085.firebasestorage.app",
        messagingSenderId: "1088302691324",
        appId: "1:1088302691324:web:8f983e4090f231fdc93879",
        measurementId: "G-JCPNXLX0T3"
      });
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const statusEl = document.getElementById('status');

    // Sahkan akses guru
    auth.onAuthStateChanged(user => {
      if (!user || localStorage.getItem('userRole') !== 'teacher') {
        window.location.href = 'index.html';
      }
    });

    /**
     * FUNGSI PENJANAAN KOD AKSES
     * Nur Qaira Zulaikha -> qaira12345
     */
    function generateAccessCode(fullName) {
        const names = fullName.trim().split(' ');
        let baseName = names[0].toLowerCase();
        
        // Elakkan guna nama awalan biasa jika ada nama kedua
        const commonPrefixes = ["nur", "ahmad", "mohd", "muhammad", "siti", "nik", "wan", "abdul"];
        if (commonPrefixes.includes(baseName) && names.length > 1) {
            baseName = names[1].toLowerCase();
        }
        
        // Hanya ambil huruf a-z (buang simbol atau 'binti')
        baseName = baseName.replace(/[^a-z]/g, '');
        
        // Jika nama terlalu pendek selepas dibersihkan, gunakan nama asal
        if (baseName.length < 2) baseName = "user";

        // Tambah 5 digit rawak
        const randomDigits = Math.floor(10000 + Math.random() * 90000);
        return baseName + randomDigits;
    }

    async function importCSV() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) {
        statusEl.textContent = '‚ùå Sila pilih fail CSV dahulu.';
        statusEl.className = "mt-4 text-sm text-center text-red-400";
        return;
      }

      statusEl.textContent = '‚è≥ Membaca fail...';
      statusEl.className = "mt-4 text-sm text-center text-gray-300";
      
      try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim() !== '');
        
        // Buang header jika baris pertama mengandungi perkataan 'nama'
        const startIndex = lines[0].toLowerCase().includes('nama') ? 1 : 0;
        const studentLines = lines.slice(startIndex);

        if (studentLines.length === 0) {
          statusEl.textContent = '‚ùå Tiada data murid ditemui dalam fail.';
          return;
        }

        statusEl.textContent = `‚è≥ Sedang mengimport ${studentLines.length} murid...`;

        let successCount = 0;
        let errorCount = 0;

        for (const line of studentLines) {
          const parts = line.split(',').map(s => s.trim());
          if (parts.length < 2) continue;

          const name = parts[0];
          const classCode = parts[1].toUpperCase();

          if (!name || !classCode) continue;

          // Hasilkan ID dokumen unik (berdasarkan nama dan kelas)
          const id = name.toLowerCase().replace(/\s+/g, '_') + '_' + classCode.toLowerCase().replace(/\s+/g, '');

          // JANA KOD AKSES IBU BAPA
          const accessCode = generateAccessCode(name);

          try {
            await db.collection('students').doc(id).set({
              name: name,
              class: classCode,
              accessCode: accessCode, // KOD AKSES DISIMPAN DI SINI
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            successCount++;
          } catch (err) {
            console.error('Gagal import:', name, err);
            errorCount++;
          }
        }

        statusEl.innerHTML = `
          <div class="text-green-400 font-bold">‚úîÔ∏è Import Selesai!</div>
          <div class="text-xs text-gray-400 mt-1">Berjaya: ${successCount} | Gagal: ${errorCount}</div>
        `;
      } catch (err) {
        statusEl.textContent = '‚ùå Ralat memproses fail: ' + err.message;
        statusEl.className = "mt-4 text-sm text-center text-red-400";
      }
    }
  </script>
</body>
</html>