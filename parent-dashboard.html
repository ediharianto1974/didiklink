<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Ibu Bapa | ClassTrack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0f172a, #1e293b); 
      color: white; 
      min-height: screen;
    }
    .glass { 
      background: rgba(255, 255, 255, 0.05); 
      backdrop-filter: blur(10px); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
      border-radius: 16px; 
    }
    .tab-active { 
      border-bottom: 3px solid #06b6d4; 
      color: #06b6d4; 
    }
    /* Warna Status Kehadiran */
    .st-hadir { background: #065f46; color: #10b981; border: 1px solid #10b981; }
    .st-sakit { background: #92400e; color: #fbbf24; border: 1px solid #fbbf24; }
    .st-lewat { background: #3730a3; color: #818cf8; border: 1px solid #818cf8; }
    .st-tanpa_maklum { background: #7f1d1d; color: #ef4444; border: 1px solid #ef4444; }
    .st-none { background: rgba(255,255,255,0.05); color: #4b5563; border: 1px solid rgba(255,255,255,0.1); }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="p-4 md:p-8">

  <div class="max-w-3xl mx-auto">
    <div class="glass p-6 mb-6 flex justify-between items-center shadow-xl">
      <div class="flex items-center gap-4">
        <img src="didiklink.png" alt="Logo" class="w-12 h-12">
        <div>
          <h2 id="childName" class="text-2xl font-bold tracking-tight">Memuatkan...</h2>
          <p id="childClass" class="text-cyan-400 text-sm font-semibold uppercase tracking-widest mt-1">Kelas: --</p>
        </div>
      </div>
      <button onclick="logout()" class="text-[10px] bg-red-900/30 text-red-400 px-3 py-2 rounded-lg border border-red-900/50 hover:bg-red-500 hover:text-white transition font-bold uppercase">
        Keluar
      </button>
    </div>

    <div class="flex overflow-x-auto gap-8 mb-6 border-b border-white/10 no-scrollbar">
      <button class="tab-btn pb-3 text-xs font-bold whitespace-nowrap transition uppercase tracking-widest" onclick="switchTab('exams', this)">üìù Ujian</button>
      <button class="tab-btn pb-3 text-xs font-bold whitespace-nowrap transition uppercase tracking-widest" onclick="switchTab('discipline', this)">‚öñÔ∏è Disiplin</button>
      <button class="tab-btn pb-3 text-xs font-bold whitespace-nowrap transition uppercase tracking-widest" onclick="switchTab('achievements', this)">üèÜ Pencapaian</button>
      <button class="tab-btn pb-3 text-xs font-bold whitespace-nowrap transition uppercase tracking-widest" onclick="switchTab('attendance', this)">üìÖ Kehadiran</button>
    </div>

    <div id="contentArea" class="space-y-4 min-h-[400px]">
      <div class="flex items-center justify-center py-20 text-gray-500 italic">Sila tunggu sebentar...</div>
    </div>
  </div>

    <div id="contentArea" class="space-y-4 min-h-[400px]">
      <div class="flex items-center justify-center py-20 text-gray-500 italic">Sila tunggu sebentar...</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Inisialisasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDozc46BtKOvWfBMcujmAYO89xA1q36a2E",
      authDomain: "classmanagement-d0085.firebaseapp.com",
      projectId: "classmanagement-d0085",
      storageBucket: "classmanagement-d0085.firebasestorage.app",
      messagingSenderId: "1088302691324",
      appId: "1:1088302691324:web:8f983e4090f231fdc93879"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const studentId = localStorage.getItem('parentStudentId');

    // Jika tiada sesi, balik ke login
    if (!studentId) {
      window.location.href = 'parent-login.html';
    }

    // Ambil Data Profil Murid pada permulaan
    async function init() {
      try {
        const doc = await db.collection('students').doc(studentId).get();
        if (!doc.exists) {
          alert("Rekod murid tidak ditemui.");
          logout();
          return;
        }
        const data = doc.data();
        document.getElementById('childName').textContent = data.name;
        document.getElementById('childClass').textContent = `Kelas: ${data.class}`;
        
        // Default tab: Ujian
        switchTab('exams', document.querySelector('.tab-btn'));
      } catch (err) {
        console.error(err);
      }
    }

    // Fungsi Tukar Tab
    async function switchTab(tab, btn) {
      // Kemaskini gaya butang
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
      btn.classList.add('tab-active');
      
      const area = document.getElementById('contentArea');
      area.innerHTML = '<div class="text-center py-20 opacity-50 animate-pulse text-sm">Memuatkan data...</div>';

      // Jika tab Kehadiran, panggil fungsi khas
      if (tab === 'attendance') {
        return renderAttendance();
      }

      // Ambil data dari sub-collection (exams/discipline/achievements)
      try {
        const snap = await db.collection('students').doc(studentId).collection(tab).orderBy('date', 'desc').get();
        
        if (snap.empty) {
          area.innerHTML = `<div class="glass p-12 text-center text-gray-500 italic text-sm">Tiada rekod ${tab} direkodkan oleh guru.</div>`;
          return;
        }

        let html = '';
        snap.forEach(doc => {
          const d = doc.data();
          if (tab === 'exams') {
            const isLow = parseInt(d.score) < 60;
            html += `
              <div class="glass p-5 border-l-4 ${isLow ? 'border-red-500 bg-red-500/5' : 'border-green-500'} flex justify-between items-center shadow-lg">
                <div>
                  <p class="font-bold text-lg text-white">${d.subject}</p>
                  <p class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">${d.type} ‚Ä¢ ${d.date}</p>
                </div>
                <div class="text-right">
                  <span class="text-2xl font-black ${isLow ? 'text-red-500' : 'text-green-400'}">${d.score}/${d.total}</span>
                  ${isLow ? '<p class="text-[9px] text-red-400 font-bold uppercase animate-pulse mt-1">Perhatian</p>' : ''}
                </div>
              </div>`;
          } else if (tab === 'discipline') {
            html += `
              <div class="glass p-5 border-l-4 ${d.type === 'good' ? 'border-cyan-400' : 'border-amber-500'} shadow-lg">
                <p class="text-sm leading-relaxed italic text-gray-200">"${d.note}"</p>
                <div class="flex justify-between items-center mt-4">
                  <span class="text-[10px] font-bold uppercase tracking-widest ${d.type === 'good' ? 'text-cyan-400' : 'text-amber-500'}">
                    ${d.type === 'good' ? '‚úÖ Amalan Baik' : '‚ö†Ô∏è Salah Laku'}
                  </span>
                  <span class="text-[9px] text-gray-500">${d.date}</span>
                </div>
              </div>`;
          } else if (tab === 'achievements') {
            html += `
              <div class="glass p-5 flex gap-4 items-center shadow-lg border-t border-white/5">
                <div class="text-3xl">üèÜ</div>
                <div>
                  <p class="font-bold text-yellow-400 text-lg">${d.award}</p>
                  <p class="text-xs text-gray-300 mt-1">${d.event}</p>
                  <p class="text-[10px] text-gray-500 mt-2 uppercase tracking-tighter">${d.date}</p>
                </div>
              </div>`;
          }
        });
        area.innerHTML = html;
      } catch (err) {
        area.innerHTML = `<div class="text-red-400 text-center p-10 text-xs">Ralat: ${err.message}</div>`;
      }
    }

    // FUNGSI KHAS: Render Kehadiran (Kalendar)
    async function renderAttendance() {
        const area = document.getElementById('contentArea');
        const now = new Date();
        const m = (now.getMonth() + 1).toString().padStart(2, '0');
        const y = now.getFullYear();

        // Nama Bulan dalam Bahasa Melayu
        const namaBulan = [
            "JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", 
            "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"
        ];
        const bulanSekarang = namaBulan[now.getMonth()];

        const daysInMonth = new Date(y, parseInt(m), 0).getDate();

        try {
            const snap = await db.collection('students').doc(studentId).collection('attendance')
                          .where('date', '>=', `${y}-${m}-01`).get();
            
            const data = {};
            snap.forEach(doc => data[doc.data().date] = doc.data().status);

            let grid = `
                <div class="glass p-6 shadow-xl">
                    <p class="text-center text-xs font-bold mb-6 uppercase tracking-widest text-cyan-400 border-b border-white/10 pb-4">
                        STATUS KEHADIRAN BULAN : ${bulanSekarang} ${y}
                    </p>
                    <div class="grid grid-cols-7 gap-2">`;
            
            // Header Hari
            const hari = ['A', 'I', 'S', 'R', 'K', 'J', 'S'];
            hari.forEach(h => {
                grid += `<div class="text-[9px] text-gray-500 font-bold text-center mb-2">${h}</div>`;
            });

            // Grid Tarikh
            for (let i = 1; i <= daysInMonth; i++) {
                const dStr = `${y}-${m}-${i.toString().padStart(2, '0')}`;
                const status = data[dStr] || 'none';
                grid += `<div class="h-9 flex items-center justify-center text-[10px] font-bold rounded-lg transition-all duration-300 st-${status}">${i}</div>`;
            }
            grid += `</div>
                
                <div class="mt-8 grid grid-cols-2 gap-3 border-t border-white/5 pt-6">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded st-hadir"></div> <span class="text-[9px] text-gray-400 uppercase tracking-tighter">Hadir</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded st-tanpa_maklum"></div> <span class="text-[9px] text-gray-400 uppercase tracking-tighter">Tanpa Maklum</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded st-sakit"></div> <span class="text-[9px] text-gray-400 uppercase tracking-tighter">Sakit / Cuti</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded st-lewat"></div> <span class="text-[9px] text-gray-400 uppercase tracking-tighter">Hadir Lewat</span>
                    </div>
                </div>
            </div>`;
            
            area.innerHTML = grid;
        } catch (err) {
            area.innerHTML = `<div class="text-red-400 text-center p-10 text-xs italic">Gagal memuatkan rekod kehadiran.</div>`;
        }
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    // Jalankan inisialisasi
    init();
  </script>
</body>
</html>