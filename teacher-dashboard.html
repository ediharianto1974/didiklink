<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guru | ClassTrack</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: white;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
    }
    .neon-purple { text-shadow: 0 0 8px #d400ff, 0 0 16px #d400ff; }
    /* Scrollbar styling for list */
    #studentsList::-webkit-scrollbar { width: 5px; }
    #studentsList::-webkit-scrollbar-track { background: transparent; }
    #studentsList::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6">
  
  <div class="glass-card p-4 mb-6 flex flex-col md:flex-row items-center gap-4">
    <img src="didiklink.png" alt="Logo" class="w-16 h-16">
    <div class="text-center md:text-left">
      <h1 class="text-2xl md:text-3xl font-black tracking-tighter">
        <span class="text-white">DIDIK</span><span class="text-cyan-400">LINK</span>
        <span class="text-sm font-light text-gray-400 ml-2">| Dashboard Guru</span>
      </h1>
      <p class="text-gray-400 text-sm">Urus maklumat murid, kelas, dan kod akses ibu bapa.</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <div class="space-y-6">
      <div class="glass-card p-4">
        <label class="block text-sm text-gray-300 mb-2 font-semibold">Pilih Kelas:</label>
        <select id="classSelect" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white focus:ring-2 focus:ring-purple-500 outline-none">
          <option value="">-- Memuatkan senarai kelas... --</option>
        </select>
        <div class="mt-4 flex gap-2">
            <a href="import-tool.html" class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded transition flex items-center gap-2">
                <span>ðŸ“‚</span> Import Murid (CSV)
            </a>
        </div>
      </div>

      <div class="glass-card p-4 border-t-4 border-green-500">
        <h2 class="text-lg font-semibold mb-3 flex items-center gap-2"><span>ðŸ‘¤</span> Daftar Murid Baru</h2>
        <div class="space-y-3">
          <input type="text" id="newName" placeholder="Nama Penuh Murid" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white outline-none focus:border-green-500">
          <input type="text" id="newClass" placeholder="Kelas (Contoh: 5 JUJUR)" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white outline-none focus:border-green-500 uppercase">
          <button onclick="addStudent()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded transition shadow-lg active:scale-95">
            + Simpan Murid
          </button>
          <p class="text-[10px] text-gray-400 italic">Sistem akan menjana kod akses ibu bapa secara automatik.</p>
        </div>
      </div>
    </div>

    <div class="glass-card p-4 flex flex-col h-[600px]">
      <h2 class="text-xl font-semibold mb-4 border-b border-white/10 pb-2 flex justify-between items-center">
        Senarai Murid
        <span id="studentCount" class="text-xs bg-purple-900/50 text-purple-300 px-2 py-1 rounded">0 Murid</span>
      </h2>
      <div id="studentsList" class="space-y-3 overflow-y-auto pr-2 flex-grow">
        <p class="text-gray-400 italic">Sila pilih kelas untuk melihat senarai.</p>
      </div>
    </div>

  </div>

  <div class="mt-8 text-center">
    <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300 hover:underline">Log Keluar</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Konfigurasi Firebase anda
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyDozc46BtKOvWfBMcujmAYO89xA1q36a2E",
        authDomain: "classmanagement-d0085.firebaseapp.com",
        projectId: "classmanagement-d0085",
        storageBucket: "classmanagement-d0085.firebasestorage.app",
        messagingSenderId: "1088302691324",
        appId: "1:1088302691324:web:8f983e4090f231fdc93879",
        measurementId: "G-JCPNXLX0T3"
      });
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const classSelect = document.getElementById('classSelect');
    const studentsListEl = document.getElementById('studentsList');

    // Semak akses Guru
    auth.onAuthStateChanged(user => {
      if (!user || localStorage.getItem('userRole') !== 'teacher') {
        window.location.href = 'index.html';
      } else {
        loadClasses();
      }
    });

    // LOGIK PENJANAAN KOD AKSES (Fungsi Baru)
    function generateAccessCode(fullName) {
        const names = fullName.trim().split(' ');
        let baseName = names[0].toLowerCase();
        
        // Elakkan guna Nur/Mohd sebagai base jika ada nama kedua
        const commonPrefixes = ["nur", "ahmad", "mohd", "muhammad", "muhd", "mohamad", "mohammad", "muhamad", "siti", "nik", "wan", "nor"];
        if (commonPrefixes.includes(baseName) && names.length > 1) {
            baseName = names[1].toLowerCase();
        }
        
        // Buang simbol atau pembuka kata
        baseName = baseName.replace(/[^a-z]/g, '');
        
        // Tambah 5 digit rawak
        const randomDigits = Math.floor(10000 + Math.random() * 90000);
        return baseName + randomDigits;
    }

    // Muatkan senarai kelas unik
    async function loadClasses() {
      try {
        const snapshot = await db.collection('students').get();
        const classes = new Set();
        snapshot.forEach(doc => {
          const classVal = doc.data().class;
          if (classVal) classes.add(classVal.toUpperCase());
        });

        classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        Array.from(classes).sort().forEach(cls => {
          const option = document.createElement('option');
          option.value = cls;
          option.textContent = cls;
          classSelect.appendChild(option);
        });

        const lastClass = localStorage.getItem('selectedClass');
        if (lastClass && classes.has(lastClass)) {
          classSelect.value = lastClass;
          loadStudents(lastClass);
        }
      } catch (err) {
        console.error("Gagal muatkan kelas:", err);
      }
    }

    // Fungsi Tambah Murid (Dikemaskini dengan Access Code)
    async function addStudent() {
      const name = document.getElementById('newName').value.trim();
      const className = document.getElementById('newClass').value.trim().toUpperCase();

      if (!name || !className) {
        alert("Sila isi nama dan kelas.");
        return;
      }

      const accessCode = generateAccessCode(name);

      try {
        await db.collection('students').add({
          name: name,
          class: className,
          accessCode: accessCode, // Simpan kod akses ke Firestore
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`Murid Berjaya Didaftarkan!\nKOD AKSES IBU BAPA: ${accessCode}`);
        document.getElementById('newName').value = '';
        
        loadClasses();
        if (classSelect.value === className) {
            loadStudents(className);
        }
      } catch (err) {
        alert("Ralat mendaftar murid: " + err.message);
      }
    }

    // Fungsi Padam Murid (Dikekalkan)
    window.deleteStudent = async (id, name) => {
      if (confirm(`Adakah anda pasti mahu memadam murid "${name}"? Rekod markah dan disiplin juga akan hilang.`)) {
        try {
          await db.collection('students').doc(id).delete();
          alert("Rekod murid telah dipadam.");
          loadStudents(classSelect.value);
        } catch (err) {
          alert("Gagal memadam: " + err.message);
        }
      }
    };

    // Fungsi Salin Kod (Fungsi Baru)
    window.copyCode = (code) => {
        navigator.clipboard.writeText(code).then(() => {
            alert("Kod " + code + " telah disalin!");
        });
    };

    classSelect.addEventListener('change', (e) => {
      const selected = e.target.value;
      if (selected) {
        localStorage.setItem('selectedClass', selected);
        loadStudents(selected);
      } else {
        studentsListEl.innerHTML = '<p class="text-gray-400 italic">Sila pilih kelas untuk melihat senarai.</p>';
        document.getElementById('studentCount').textContent = "0 Murid";
      }
    });

    // Paparkan Murid (Dikemaskini untuk tunjuk Access Code)
    async function loadStudents(className) {
      studentsListEl.innerHTML = '<p class="text-gray-300 animate-pulse">Memuatkan murid...</p>';
      try {
        const snapshot = await db
          .collection('students')
          .where('class', '==', className)
          .get();

        document.getElementById('studentCount').textContent = `${snapshot.size} Murid`;

        if (snapshot.empty) {
          studentsListEl.innerHTML = `<p class="text-yellow-300">Tiada murid dalam kelas <strong>${className}</strong>.</p>`;
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const studentId = doc.id;
          const aCode = data.accessCode || 'N/A';
          
          html += `
            <div class="glass-card p-4 flex flex-col md:flex-row justify-between md:items-center gap-3 hover:bg-white/10 transition border-l-2 border-transparent hover:border-cyan-400">
              <div>
                <span class="font-bold text-sm block">${data.name}</span>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] bg-gray-700 text-yellow-400 px-2 py-0.5 rounded font-mono">KOD: ${aCode}</span>
                    <button onclick="copyCode('${aCode}')" class="text-[9px] text-gray-400 hover:text-white underline">Salin</button>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="viewStudent('${studentId}')" class="flex-1 md:flex-none text-[10px] bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded font-bold uppercase tracking-wider">Profil</button>
                <button onclick="deleteStudent('${studentId}', '${data.name}')" class="text-[10px] bg-red-600/30 text-red-400 hover:bg-red-600 hover:text-white px-3 py-2 rounded transition">PADAM</button>
              </div>
            </div>
          `;
        });
        studentsListEl.innerHTML = html;
      } catch (err) {
        studentsListEl.innerHTML = `<p class="text-red-300">Ralat: ${err.message}</p>`;
      }
    }

    window.viewStudent = (id) => {
      window.location.href = `student-profile.html?id=${id}`;
    };

    window.logout = () => {
      auth.signOut().then(() => {
        localStorage.removeItem('userRole');
        window.location.href = 'index.html';
      });
    };
  </script>
</body>
</html>